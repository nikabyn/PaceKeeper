image: "$CI_REGISTRY/pacing-app/ui/android-sdk:latest"

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: 0

before_script:
  - chmod +x ./gradlew

stages:
  - analyze
  - test
  - release

# -------------------------------------------------------------
# Analyze
# -------------------------------------------------------------
lintDebug:
  stage: analyze
  script:
    - ./gradlew -Pci --console=plain :app:lintDebug -PbuildDir=lint
  artifacts:
    paths:
      - app/lint/reports/

#sonarqubeAnalysis:
#  stage: analyze
#  cache:
#    policy: pull-push
#    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
#    paths:
#      - "${SONAR_USER_HOME}/cache"
#      - sonar-scanner/
#  script:
#    - ./gradlew clean build --stacktrace
#    - ./gradlew sonar -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.projectName=$SONAR_PROJECT_NAME -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN -Dsonar.qualitygate.wait=true
#  allow_failure: false
#  artifacts:
#    when: always
#    paths:
#      - build/reports/
#      - app/build/reports/
#      - app/build/test-results/
#      - app/build/jacoco/

# -------------------------------------------------------------
# Test
# -------------------------------------------------------------
debugUnitTests:
  stage: test
  script:
    - ./gradlew -Pci --console=plain :app:testDebugUnitTest
  artifacts:
    when: always
    paths:
      - app/build/test-results/testDebugUnitTest/
      - app/build/reports/tests/testDebugUnitTest/


.connected_tests_template:
  stage: test
  script:
    - /opt/start-avds.sh
    - ./gradlew -Pci --console=plain :app:connectedDebugAndroidTest
  after_script:
    - echo "Kill emulator â€¦"
    - adb -s emulator-5554 emu kill || true
    - pkill -f qemu-system 2>/dev/null || true
  artifacts:
    when: always
    paths:
      - app/build/reports/androidTests/connected/
      - app/build/outputs/androidTest-results/connected/
  allow_failure: false
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      when: always
    - when: never

connectedInstrumentationTests:
  extends: .connected_tests_template
  tags:
    - android
  parallel:
    matrix:
      - ANDROID_API: [ "28", "35" ]
  image: "$CI_REGISTRY/pacing-app/ui/android-sdk:latest"


# -------------------------------------------------------------
# Builds
# -------------------------------------------------------------
assembleDebug:
  stage: release
  script:
    - ./gradlew clean assembleDebug
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'
      changes:
        - '**/*'

assembleRelease:
  stage: release
  script:
    - ./gradlew clean assembleRelease
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - '**/*'
  artifacts:
    paths:
      - app/build/outputs/
