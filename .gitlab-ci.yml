image: "$CI_REGISTRY/pacing-app/ui/android-sdk:latest"

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: 0
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

before_script:
  - chmod +x ./gradlew

stages:
  - analyze
  - test
  - quality
  - release

cache:
  key:
    files:
      - gradle/wrapper/gradle-wrapper.properties
  policy: pull-push
  paths:
    - .gradle/caches/
    - .gradle/wrapper/
    - build/

# -------------------------------------------------------------
# Analyze
# -------------------------------------------------------------
lintDebug:
  stage: analyze
  script:
    - ./gradlew -Pci --console=plain :app:lintDebug -PbuildDir=lint
  artifacts:
    paths:
      - app/lint/reports/

# -------------------------------------------------------------
# Test
# -------------------------------------------------------------
debugUnitTests:
  stage: test
  script:
    - ./gradlew -Pci --console=plain :app:testDebugUnitTest
  rules:
    - when: always
  artifacts:
    when: always
    paths:
      - app/build/test-results/testDebugUnitTest/
      - app/build/reports/tests/testDebugUnitTest/
      - app/build/jacoco/

.connected_tests_template:
  stage: test
  script:
    - /opt/start-avds.sh
    - ./gradlew -Pci --console=plain :app:connectedDebugAndroidTest
  after_script:
    - pkill -f qemu-system 2>/dev/null || true
  artifacts:
    when: always
    paths:
      - app/build/reports/androidTests/connected/
      - app/build/reports/coverage/androidTest/
      - app/build/outputs/androidTest-results/connected/
      - app/build/jacoco/
  allow_failure: false
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH'
      when: always
    - when: never

connectedInstrumentationTests:
  extends: .connected_tests_template
  tags:
    - android
  parallel:
    matrix:
      - ANDROID_API: [ "28", "35" ]
  image: "$CI_REGISTRY/pacing-app/ui/android-sdk:latest"

# -------------------------------------------------------------
# Quality
# -------------------------------------------------------------

sonarqubeUnit:
  stage: quality
  needs:
    - debugUnitTests
  rules:
    - if: '$CI_PIPELINE_SOURCE != "merge_request_event"'
  script:
    - ./gradlew jacocoUnitTestReport
    - ./gradlew sonar -Dsonar.coverage.jacoco.xmlReportPaths=$CI_PROJECT_DIR/app/build/reports/jacoco/jacocoUnitTestReport/jacocoUnitTestReport.xml -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.projectName=$SONAR_PROJECT_NAME -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN -Dsonar.qualitygate.wait=true
  artifacts:
    when: always
    paths:
      - app/build/reports/

sonarqubeMerged:
  stage: quality
  needs:
    - debugUnitTests
    - connectedInstrumentationTests
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH'
  script:
    - ./gradlew jacocoMergedReport
    - ./gradlew sonar -Dsonar.coverage.jacoco.xmlReportPaths=$CI_PROJECT_DIR/app/build/reports/jacoco/jacocoMergedReport/jacocoMergedReport.xml -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.projectName=$SONAR_PROJECT_NAME -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN -Dsonar.qualitygate.wait=true
  artifacts:
    when: always
    paths:
      - app/build/reports/

# -------------------------------------------------------------
# Builds
# -------------------------------------------------------------
assembleDebug:
  stage: release
  script:
    - ./gradlew clean assembleDebug
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'
      changes:
        - '**/*'

assembleRelease:
  stage: release
  script:
    - ./gradlew clean assembleRelease
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - '**/*'
  artifacts:
    paths:
      - app/build/outputs/
